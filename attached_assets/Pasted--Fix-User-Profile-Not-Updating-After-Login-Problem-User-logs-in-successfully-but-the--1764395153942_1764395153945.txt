# üîß Fix: User Profile Not Updating After Login

## Problem

User logs in successfully, but the Account Settings page still shows:
- Username: @Guest
- Email: user@example.com

This means the user context isn't updating properly after authentication.

---

## Root Causes

1. **User context not refetching** after login
2. **Stale data** from initial render
3. **Missing user data refresh** in auth flow

---

## ‚úÖ Solution 1: Fix Auth Context

### Update AuthContext to Refresh User Data

```typescript
// client/src/contexts/AuthContext.tsx

import { createContext, useContext, useState, useEffect, ReactNode } from 'react';
import { useToast } from '@/hooks/use-toast';

interface User {
  id: number;
  username: string;
  email: string;
  displayName?: string;
  avatarUrl?: string;
  isPremium?: boolean;
}

interface AuthContextType {
  user: User | null;
  isLoading: boolean;
  login: (username: string, password: string) => Promise<void>;
  register: (username: string, email: string, password: string) => Promise<void>;
  logout: () => Promise<void>;
  refreshUser: () => Promise<void>;
}

const AuthContext = createContext<AuthContextType | undefined>(undefined);

export function AuthProvider({ children }: { children: ReactNode }) {
  const [user, setUser] = useState<User | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const { toast } = useToast();

  // Fetch current user on mount
  const fetchUser = async () => {
    try {
      const response = await fetch('/api/user/me', {
        credentials: 'include'
      });

      if (response.ok) {
        const userData = await response.json();
        console.log('[Auth] User loaded:', userData);
        setUser(userData);
      } else {
        console.log('[Auth] No user session');
        setUser(null);
      }
    } catch (error) {
      console.error('[Auth] Failed to fetch user:', error);
      setUser(null);
    } finally {
      setIsLoading(false);
    }
  };

  useEffect(() => {
    fetchUser();
  }, []);

  const login = async (username: string, password: string) => {
    try {
      const response = await fetch('/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ username, password })
      });

      if (!response.ok) {
        const error = await response.text();
        throw new Error(error || 'Login failed');
      }

      const userData = await response.json();
      console.log('[Auth] Login successful:', userData);
      
      // CRITICAL: Update user state immediately
      setUser(userData);

      toast({
        title: 'Welcome back!',
        description: `Logged in as ${userData.username}`
      });
    } catch (error) {
      console.error('[Auth] Login error:', error);
      toast({
        title: 'Login Failed',
        description: error instanceof Error ? error.message : 'Invalid credentials',
        variant: 'destructive'
      });
      throw error;
    }
  };

  const register = async (username: string, email: string, password: string) => {
    try {
      const response = await fetch('/api/auth/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ username, email, password })
      });

      if (!response.ok) {
        const error = await response.text();
        throw new Error(error || 'Registration failed');
      }

      const userData = await response.json();
      console.log('[Auth] Registration successful:', userData);
      
      // CRITICAL: Update user state immediately
      setUser(userData);

      toast({
        title: 'Account Created!',
        description: `Welcome to Lyric Sensei, ${userData.username}!`
      });
    } catch (error) {
      console.error('[Auth] Registration error:', error);
      toast({
        title: 'Registration Failed',
        description: error instanceof Error ? error.message : 'Could not create account',
        variant: 'destructive'
      });
      throw error;
    }
  };

  const logout = async () => {
    try {
      await fetch('/api/auth/logout', {
        method: 'POST',
        credentials: 'include'
      });

      setUser(null);

      toast({
        title: 'Logged Out',
        description: 'See you next time!'
      });
    } catch (error) {
      console.error('[Auth] Logout error:', error);
    }
  };

  // Add refresh function
  const refreshUser = async () => {
    await fetchUser();
  };

  return (
    <AuthContext.Provider value={{ 
      user, 
      isLoading, 
      login, 
      register, 
      logout,
      refreshUser 
    }}>
      {children}
    </AuthContext.Provider>
  );
}

export function useAuth() {
  const context = useContext(AuthContext);
  if (!context) {
    throw new Error('useAuth must be used within AuthProvider');
  }
  return context;
}
```

---

## ‚úÖ Solution 2: Fix Account Settings Page

```typescript
// client/src/pages/account.tsx

import { useAuth } from '@/contexts/AuthContext';
import { Button } from '@/components/ui/button';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import { Pencil, Loader2 } from 'lucide-react';
import { useEffect } from 'react';

export default function AccountSettings() {
  const { user, isLoading, refreshUser } = useAuth();

  // Refresh user data when page loads
  useEffect(() => {
    console.log('[Account] Current user:', user);
    
    // If user seems stale, refresh
    if (user && user.username === 'Guest') {
      console.log('[Account] User data seems stale, refreshing...');
      refreshUser();
    }
  }, []);

  if (isLoading) {
    return (
      <div className="flex items-center justify-center h-screen">
        <Loader2 className="h-8 w-8 animate-spin" />
      </div>
    );
  }

  if (!user) {
    return (
      <div className="container max-w-4xl mx-auto p-6">
        <h1 className="text-3xl font-bold mb-2">Account Settings</h1>
        <p className="text-muted-foreground mb-8">Please log in to view your account</p>
        <Button onClick={() => window.location.href = '/login'}>
          Log In
        </Button>
      </div>
    );
  }

  return (
    <div className="container max-w-4xl mx-auto p-6">
      <h1 className="text-3xl font-bold mb-2">Account Settings</h1>
      <p className="text-muted-foreground mb-8">Manage your account and subscription</p>

      {/* My Profile Card */}
      <div className="bg-card border rounded-lg p-6 mb-6">
        <div className="flex items-center justify-between mb-6">
          <h2 className="text-2xl font-bold">My Profile</h2>
          <Button variant="outline" size="sm">
            <Pencil className="h-4 w-4 mr-2" />
            Edit Profile
          </Button>
        </div>

        <div className="flex items-start gap-6">
          {/* Avatar */}
          <Avatar className="h-32 w-32">
            <AvatarImage src={user.avatarUrl} />
            <AvatarFallback className="text-3xl">
              {user.username?.[0]?.toUpperCase() || 'U'}
            </AvatarFallback>
          </Avatar>

          {/* User Info */}
          <div className="flex-1 space-y-4">
            <div>
              <label className="text-sm text-muted-foreground uppercase tracking-wider">
                Username
              </label>
              <p className="text-lg font-medium">@{user.username}</p>
            </div>

            <div>
              <label className="text-sm text-muted-foreground uppercase tracking-wider">
                Email
              </label>
              <p className="text-lg">{user.email}</p>
            </div>

            {user.displayName && (
              <div>
                <label className="text-sm text-muted-foreground uppercase tracking-wider">
                  Display Name
                </label>
                <p className="text-lg">{user.displayName}</p>
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Subscription Card */}
      <div className="bg-card border rounded-lg p-6">
        <h2 className="text-2xl font-bold mb-4">Subscription</h2>
        
        {user.isPremium ? (
          <div className="space-y-4">
            <div className="flex items-center gap-2">
              <div className="bg-primary text-primary-foreground px-3 py-1 rounded-full text-sm font-medium">
                Premium
              </div>
            </div>
            <p className="text-muted-foreground">
              You have access to all premium features
            </p>
          </div>
        ) : (
          <div className="space-y-4">
            <div className="flex items-center gap-2">
              <div className="bg-muted text-muted-foreground px-3 py-1 rounded-full text-sm font-medium">
                Free
              </div>
            </div>
            <p className="text-muted-foreground">
              Upgrade to Premium for ad-free experience and more features
            </p>
            <Button className="bg-primary">
              Upgrade to Premium
            </Button>
          </div>
        )}
      </div>
    </div>
  );
}
```

---

## ‚úÖ Solution 3: Fix Backend /api/user/me Endpoint

Make sure this endpoint exists and returns user data:

```typescript
// server/routes.ts

app.get('/api/user/me', async (req, res) => {
  if (!req.isAuthenticated()) {
    return res.status(401).send('Not authenticated');
  }

  try {
    const user = await db.query.users.findFirst({
      where: eq(users.id, req.user.id)
    });

    if (!user) {
      return res.status(404).send('User not found');
    }

    // Return user data (exclude password)
    const { password, ...userData } = user;
    res.json(userData);
  } catch (error) {
    console.error('Failed to fetch user:', error);
    res.status(500).send('Failed to fetch user data');
  }
});
```

---

## ‚úÖ Solution 4: Fix Login Flow

Ensure login returns user data:

```typescript
// server/routes.ts

app.post('/api/auth/login', passport.authenticate('local'), (req, res) => {
  // Return user data after successful login
  const { password, ...userData } = req.user;
  
  console.log('[Auth] User logged in:', userData);
  
  res.json(userData);
});

app.post('/api/auth/register', async (req, res) => {
  try {
    const { username, email, password } = req.body;

    // Check if user exists
    const existingUser = await db.query.users.findFirst({
      where: or(
        eq(users.username, username),
        eq(users.email, email)
      )
    });

    if (existingUser) {
      return res.status(400).send('Username or email already exists');
    }

    // Hash password
    const hashedPassword = await bcrypt.hash(password, 10);

    // Create user
    const [newUser] = await db.insert(users).values({
      username,
      email,
      password: hashedPassword
    }).returning();

    // Log user in
    req.login(newUser, (err) => {
      if (err) {
        console.error('[Auth] Login after registration failed:', err);
        return res.status(500).send('Registration successful but login failed');
      }

      // Return user data
      const { password: _, ...userData } = newUser;
      
      console.log('[Auth] User registered and logged in:', userData);
      
      res.json(userData);
    });
  } catch (error) {
    console.error('[Auth] Registration error:', error);
    res.status(500).send('Registration failed');
  }
});
```

---

## üîç Debugging Checklist

Add these console logs to track the issue:

```typescript
// In Account Settings page
useEffect(() => {
  console.log('=== ACCOUNT PAGE DEBUG ===');
  console.log('User from context:', user);
  console.log('Is loading:', isLoading);
  console.log('User username:', user?.username);
  console.log('User email:', user?.email);
  console.log('========================');
}, [user, isLoading]);

// In AuthContext
useEffect(() => {
  console.log('=== AUTH CONTEXT DEBUG ===');
  console.log('User state changed:', user);
  console.log('========================');
}, [user]);
```

---

## üéØ Expected Flow

1. User logs in ‚Üí `/api/auth/login` returns user data
2. AuthContext `setUser(userData)` updates state
3. Account Settings page receives updated user from context
4. Page displays: `@actualUsername` and `actual@email.com`

---

## üö® Common Issues

**Issue 1: User context not wrapping app**
```typescript
// main.tsx - Make sure AuthProvider wraps everything
<AuthProvider>
  <App />
</AuthProvider>
```

**Issue 2: Cookies not being sent**
```typescript
// Add credentials to all fetch calls
fetch('/api/user/me', {
  credentials: 'include'  // ‚Üê CRITICAL
});
```

**Issue 3: Session not persisting**
```typescript
// Check express-session config
app.use(session({
  secret: process.env.SESSION_SECRET || 'your-secret',
  resave: false,
  saveUninitialized: false,
  cookie: {
    secure: process.env.NODE_ENV === 'production',
    httpOnly: true,
    maxAge: 1000 * 60 * 60 * 24 * 7 // 7 days
  }
}));
```

---

## üéØ Test

1. Log in with valid credentials
2. Check console logs: Should see `[Auth] Login successful: { username: 'realuser', email: 'real@email.com' }`
3. Navigate to Account Settings
4. Should display actual username and email, not "Guest"

**The user context should update immediately after login!** üîß‚ú®