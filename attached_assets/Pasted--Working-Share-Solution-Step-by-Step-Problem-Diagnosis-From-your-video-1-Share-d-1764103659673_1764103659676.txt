# ðŸ”§ Working Share Solution - Step by Step

## Problem Diagnosis

From your video:
1. âœ… Share dialog opens
2. âœ… Apps are detected (Instagram, Snapchat, etc.)
3. âŒ Apps open but receive NO content
4. âŒ No image, no text, no link

**Root Cause:** Capacitor's Share API isn't properly configured or the content format is wrong.

---

## âœ… Working Solution

### Step 1: Install Correct Plugin Version

```bash
# Remove old version
npm uninstall @capacitor/share

# Install latest
npm install @capacitor/share@latest

# Sync
npx cap sync android
npx cap sync ios
```

---

### Step 2: Use Social Sharing Plugin (Better Alternative)

Capacitor's Share API is limited. Use this plugin instead:

```bash
# Install better plugin
npm install cordova-plugin-x-socialsharing
npm install @awesome-cordova-plugins/social-sharing

# Install Capacitor wrapper
npm install @capacitor/core

# Sync
npx cap sync
```

---

### Step 3: Update Share Implementation

```typescript
// client/src/components/ShareSheet.tsx

import { useState, useRef } from 'react';
import { Filesystem, Directory } from '@capacitor/filesystem';
import { Capacitor } from '@capacitor/core';
import { toPng } from 'html-to-image';
import { Dialog, DialogContent } from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { toast } from '@/hooks/use-toast';

declare global {
  interface Window {
    plugins?: {
      socialsharing?: {
        shareViaInstagramToStory: (
          backgroundImage: string,
          stickerImage: string | null,
          backgroundTopColor: string,
          backgroundBottomColor: string,
          successCallback: () => void,
          errorCallback: (error: string) => void
        ) => void;
        shareVia: (
          appName: string,
          message: string,
          subject: string | null,
          file: string | null,
          url: string | null,
          successCallback: () => void,
          errorCallback: (error: string) => void
        ) => void;
        share: (
          message: string,
          subject: string | null,
          file: string | null,
          url: string | null,
          successCallback: () => void,
          errorCallback: (error: string) => void
        ) => void;
      };
    };
  }
}

interface ShareSheetProps {
  open: boolean;
  onClose: () => void;
  songTitle: string;
  artistName: string;
  albumArtwork: string;
  songUrl: string;
  currentLyric?: string;
}

export function ShareSheet({
  open,
  onClose,
  songTitle,
  artistName,
  albumArtwork,
  songUrl,
  currentLyric
}: ShareSheetProps) {
  const [isGenerating, setIsGenerating] = useState(false);
  const cardRef = useRef<HTMLDivElement>(null);

  // Generate and save image
  const generateImage = async (): Promise<string> => {
    if (!cardRef.current) {
      throw new Error('Story card not ready');
    }

    try {
      console.log('[Share] Generating image...');

      // Generate PNG
      const dataUrl = await toPng(cardRef.current, {
        quality: 1.0,
        pixelRatio: 2,
        width: 1080,
        height: 1920,
        cacheBust: true,
        backgroundColor: '#667eea'
      });

      // Extract base64
      const base64Data = dataUrl.split(',')[1];

      // Save to filesystem
      const fileName = `lyric-sensei-story-${Date.now()}.png`;
      
      const result = await Filesystem.writeFile({
        path: fileName,
        data: base64Data,
        directory: Directory.Cache
      });

      console.log('[Share] Image saved to:', result.uri);

      // Return the file path (not URI)
      // For Android, we need the actual file path
      if (Capacitor.getPlatform() === 'android') {
        // Get the actual file path
        const stat = await Filesystem.stat({
          path: fileName,
          directory: Directory.Cache
        });
        console.log('[Share] File stat:', stat);
        return result.uri;
      }

      return result.uri;

    } catch (error) {
      console.error('[Share] Image generation failed:', error);
      throw error;
    }
  };

  // Instagram Stories (using native plugin)
  const shareToInstagram = async () => {
    try {
      setIsGenerating(true);
      console.log('[Instagram] Starting share...');

      const imageUri = await generateImage();
      console.log('[Instagram] Image URI:', imageUri);

      if (window.plugins?.socialsharing) {
        // Use native plugin
        console.log('[Instagram] Using native plugin...');
        
        window.plugins.socialsharing.shareViaInstagramToStory(
          imageUri,
          null, // No sticker
          '#667eea', // Top color
          '#764ba2', // Bottom color
          () => {
            console.log('[Instagram] Share success!');
            toast({
              title: 'Shared!',
              description: 'Opening Instagram Stories...'
            });
            onClose();
          },
          (error) => {
            console.error('[Instagram] Share failed:', error);
            toast({
              title: 'Share Failed',
              description: 'Instagram may not be installed',
              variant: 'destructive'
            });
          }
        );
      } else {
        // Fallback: Use intent URL (Android only)
        console.log('[Instagram] Using intent fallback...');
        
        const instagramUrl = `instagram://library?AssetPath=${encodeURIComponent(imageUri)}`;
        window.location.href = instagramUrl;
        
        setTimeout(() => {
          toast({
            title: 'Opening Instagram',
            description: 'Please select the story from your library'
          });
          onClose();
        }, 1000);
      }

    } catch (error) {
      console.error('[Instagram] Error:', error);
      toast({
        title: 'Share Failed',
        description: error instanceof Error ? error.message : 'Unknown error',
        variant: 'destructive'
      });
    } finally {
      setIsGenerating(false);
    }
  };

  // Snapchat
  const shareToSnapchat = async () => {
    try {
      setIsGenerating(true);
      console.log('[Snapchat] Starting share...');

      const imageUri = await generateImage();

      if (window.plugins?.socialsharing) {
        window.plugins.socialsharing.shareVia(
          'com.snapchat.android', // Snapchat package
          `${songTitle} by ${artistName}`,
          null,
          imageUri,
          null,
          () => {
            console.log('[Snapchat] Share success!');
            toast({ title: 'Shared to Snapchat!' });
            onClose();
          },
          (error) => {
            console.error('[Snapchat] Share failed:', error);
            toast({
              title: 'Share Failed',
              description: 'Snapchat may not be installed',
              variant: 'destructive'
            });
          }
        );
      } else {
        // Fallback
        const snapchatUrl = `snapchat://add`;
        window.location.href = snapchatUrl;
        onClose();
      }

    } catch (error) {
      console.error('[Snapchat] Error:', error);
    } finally {
      setIsGenerating(false);
    }
  };

  // Twitter
  const shareToTwitter = async () => {
    try {
      setIsGenerating(true);
      console.log('[Twitter] Starting share...');

      const text = `ðŸŽµ Listening to "${songTitle}" by ${artistName} on Lyric Sensei\n\n${songUrl}`;
      const imageUri = await generateImage();

      if (window.plugins?.socialsharing) {
        window.plugins.socialsharing.shareVia(
          'com.twitter.android',
          text,
          null,
          imageUri,
          null,
          () => {
            console.log('[Twitter] Share success!');
            toast({ title: 'Shared to Twitter!' });
            onClose();
          },
          (error) => {
            console.error('[Twitter] Share failed:', error);
            // Fallback to web
            const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
            window.open(twitterUrl, '_blank');
            onClose();
          }
        );
      } else {
        // Web fallback
        const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
        window.open(twitterUrl, '_blank');
        onClose();
      }

    } catch (error) {
      console.error('[Twitter] Error:', error);
    } finally {
      setIsGenerating(false);
    }
  };

  // Copy Link
  const copyLink = async () => {
    try {
      await navigator.clipboard.writeText(songUrl);
      toast({
        title: 'Link Copied!',
        description: 'Song link copied to clipboard'
      });
      onClose();
    } catch (error) {
      // Fallback
      const input = document.createElement('input');
      input.value = songUrl;
      document.body.appendChild(input);
      input.select();
      document.execCommand('copy');
      document.body.removeChild(input);
      toast({ title: 'Link Copied!' });
      onClose();
    }
  };

  // More (generic share)
  const shareMore = async () => {
    try {
      setIsGenerating(true);
      
      const message = `Check out ${songTitle} by ${artistName} on Lyric Sensei`;
      const imageUri = await generateImage();

      if (window.plugins?.socialsharing) {
        window.plugins.socialsharing.share(
          message,
          songTitle,
          imageUri,
          songUrl,
          () => {
            console.log('[Share] Success!');
            onClose();
          },
          (error) => {
            console.error('[Share] Failed:', error);
          }
        );
      } else {
        // Fallback to Web Share API
        if (navigator.share) {
          await navigator.share({
            title: songTitle,
            text: message,
            url: songUrl
          });
          onClose();
        } else {
          toast({
            title: 'Share Not Supported',
            description: 'Please copy the link instead',
            variant: 'destructive'
          });
        }
      }

    } catch (error) {
      console.error('[Share] Error:', error);
    } finally {
      setIsGenerating(false);
    }
  };

  return (
    <>
      {/* Hidden story card for image generation */}
      <div
        style={{
          position: 'absolute',
          left: '-10000px',
          top: '-10000px',
          width: '1080px',
          height: '1920px'
        }}
      >
        <div
          ref={cardRef}
          style={{
            width: '1080px',
            height: '1920px',
            position: 'relative',
            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            fontFamily: 'system-ui, -apple-system, sans-serif'
          }}
        >
          {/* Background with album art (blurred) */}
          <div
            style={{
              position: 'absolute',
              inset: 0,
              backgroundImage: `url(${albumArtwork})`,
              backgroundSize: 'cover',
              backgroundPosition: 'center',
              filter: 'blur(40px) brightness(0.4)',
              opacity: 0.8
            }}
          />

          {/* Content */}
          <div
            style={{
              position: 'relative',
              height: '100%',
              display: 'flex',
              flexDirection: 'column',
              justifyContent: 'space-between',
              padding: '80px 60px'
            }}
          >
            {/* Top: App branding */}
            <div style={{ textAlign: 'center' }}>
              <div
                style={{
                  fontSize: '48px',
                  fontWeight: 'bold',
                  color: 'white',
                  letterSpacing: '2px'
                }}
              >
                LYRIC SENSEI
              </div>
            </div>

            {/* Middle: Album art + song info */}
            <div
              style={{
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                gap: '40px'
              }}
            >
              <img
                src={albumArtwork}
                alt={songTitle}
                style={{
                  width: '600px',
                  height: '600px',
                  borderRadius: '24px',
                  objectFit: 'cover',
                  boxShadow: '0 30px 60px rgba(0,0,0,0.5)'
                }}
                crossOrigin="anonymous"
              />

              <div style={{ textAlign: 'center', maxWidth: '900px' }}>
                <div
                  style={{
                    fontSize: '72px',
                    fontWeight: 'bold',
                    color: 'white',
                    marginBottom: '20px',
                    lineHeight: 1.2
                  }}
                >
                  {songTitle}
                </div>
                <div
                  style={{
                    fontSize: '48px',
                    color: 'rgba(255,255,255,0.8)'
                  }}
                >
                  {artistName}
                </div>
              </div>

              {currentLyric && (
                <div
                  style={{
                    background: 'rgba(255,255,255,0.15)',
                    backdropFilter: 'blur(10px)',
                    padding: '40px',
                    borderRadius: '16px',
                    maxWidth: '900px',
                    textAlign: 'center'
                  }}
                >
                  <div
                    style={{
                      fontSize: '44px',
                      color: 'white',
                      fontStyle: 'italic',
                      lineHeight: 1.5
                    }}
                  >
                    "{currentLyric}"
                  </div>
                </div>
              )}
            </div>

            {/* Bottom: Attribution */}
            <div style={{ textAlign: 'center' }}>
              <div
                style={{
                  fontSize: '36px',
                  color: 'rgba(255,255,255,0.9)'
                }}
              >
                lyricsensei.com
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Share Dialog */}
      <Dialog open={open} onOpenChange={onClose}>
        <DialogContent className="max-w-md">
          <div className="space-y-2">
            <h2 className="text-xl font-semibold mb-2">Share with anyone</h2>
            <p className="text-sm text-muted-foreground mb-4">
              Music shared from Lyric Sensei can be opened on other services
            </p>

            {/* Instagram */}
            <Button
              variant="ghost"
              className="w-full justify-start h-16"
              onClick={shareToInstagram}
              disabled={isGenerating}
            >
              <div className="w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 via-pink-500 to-orange-500 flex items-center justify-center mr-3">
                <Instagram className="h-5 w-5 text-white" />
              </div>
              <span className="text-base">Instagram Stories</span>
              {isGenerating && (
                <Loader2 className="ml-auto h-4 w-4 animate-spin" />
              )}
            </Button>

            {/* Snapchat */}
            <Button
              variant="ghost"
              className="w-full justify-start h-16"
              onClick={shareToSnapchat}
              disabled={isGenerating}
            >
              <div className="w-10 h-10 rounded-full bg-yellow-400 flex items-center justify-center mr-3">
                <MessageCircle className="h-5 w-5 text-white" />
              </div>
              <span className="text-base">Snapchat</span>
            </Button>

            {/* Twitter */}
            <Button
              variant="ghost"
              className="w-full justify-start h-16"
              onClick={shareToTwitter}
            >
              <div className="w-10 h-10 rounded-full bg-blue-400 flex items-center justify-center mr-3">
                <Twitter className="h-5 w-5 text-white" />
              </div>
              <span className="text-base">Twitter</span>
            </Button>

            {/* Copy Link */}
            <Button
              variant="ghost"
              className="w-full justify-start h-16"
              onClick={copyLink}
            >
              <div className="w-10 h-10 rounded-full bg-teal-500 flex items-center justify-center mr-3">
                <Link2 className="h-5 w-5 text-white" />
              </div>
              <span className="text-base">Copy track link</span>
            </Button>

            {/* More Options */}
            <Button
              variant="ghost"
              className="w-full justify-start h-16"
              onClick={shareMore}
            >
              <div className="w-10 h-10 rounded-full bg-gray-600 flex items-center justify-center mr-3">
                <MoreHorizontal className="h-5 w-5 text-white" />
              </div>
              <span className="text-base">More</span>
            </Button>
          </div>
        </DialogContent>
      </Dialog>
    </>
  );
}
```

---

### Step 4: Add Plugin Configuration

**Android: config.xml**
```xml
<!-- Add to android/app/src/main/res/xml/config.xml -->
<widget>
  <feature name="SocialSharing">
    <param name="android-package" value="nl.xservices.plugins.SocialSharing" />
  </feature>
</widget>
```

**Android: AndroidManifest.xml**
```xml
<!-- Add queries for apps -->
<queries>
    <package android:name="com.instagram.android" />
    <package android:name="com.snapchat.android" />
    <package android:name="com.twitter.android" />
</queries>

<!-- Add FileProvider for sharing images -->
<application>
    <provider
        android:name="androidx.core.content.FileProvider"
        android:authorities="${applicationId}.fileprovider"
        android:exported="false"
        android:grantUriPermissions="true">
        <meta-data
            android:name="android.support.FILE_PROVIDER_PATHS"
            android:resource="@xml/file_paths" />
    </provider>
</application>
```

**Create file_paths.xml:**
```xml
<!-- android/app/src/main/res/xml/file_paths.xml -->
<?xml version="1.0" encoding="utf-8"?>
<paths>
    <cache-path name="cache" path="." />
    <external-cache-path name="external-cache" path="." />
</paths>
```

---

### Step 5: Rebuild App

```bash
# Clean and rebuild
cd android
./gradlew clean
cd ..

# Build
npm run build

# Sync
npx cap sync android

# Open in Android Studio
npx cap open android

# Build and run from Android Studio
```

---

## ðŸŽ¯ Testing Checklist

1. **Generate Image**
   - Open Chrome DevTools (chrome://inspect)
   - Click share button
   - Check console: "Image saved to: file://..."

2. **Check Plugin**
   - Console: `window.plugins.socialsharing`
   - Should not be undefined

3. **Test Share**
   - Click Instagram button
   - Should open Instagram with image loaded

---

## ðŸš¨ If Still Not Working

### Alternative: Simple File Share

```typescript
import { Share } from '@capacitor/share';
import { Filesystem, Directory } from '@capacitor/filesystem';

const simpleShare = async () => {
  try {
    // Generate image
    const imageUri = await generateImage();
    
    // Convert to shareable format
    const readFile = await Filesystem.readFile({
      path: fileName,
      directory: Directory.Cache
    });
    
    // Create blob
    const blob = await fetch(`data:image/png;base64,${readFile.data}`).then(r => r.blob());
    
    // Use Web Share API
    const file = new File([blob], 'story.png', { type: 'image/png' });
    
    await navigator.share({
      files: [file],
      title: songTitle,
      text: `${songTitle} by ${artistName}`
    });
    
  } catch (error) {
    console.error('Share failed:', error);
  }
};
```

---

## ðŸ“± Expected Behavior

1. âœ… Click "Instagram Stories"
2. âœ… See "Generating..." (2-3 seconds)
3. âœ… Instagram opens
4. âœ… Image appears in Instagram story editor
5. âœ… User can post to story

**The key is using the Social Sharing plugin instead of Capacitor's Share API!**