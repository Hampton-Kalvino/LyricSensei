# üîß Fix: Hash Router Stripping Query Parameters

## Problem

When clicking the email link `lyricsensei.com/#/auth/reset-password?token=abc123`, the URL becomes just `lyricsensei.com/#` - the token is lost.

This happens because `wouter`'s `useHashLocation` doesn't preserve query parameters properly.

---

## ‚úÖ Solution 1: Put Token in Hash Path (Recommended)

Instead of using query parameters, put the token directly in the URL path:

### Backend: Generate URL with Token in Path

```typescript
// server/routes.ts

app.post('/api/auth/forgot-password', async (req, res) => {
  try {
    const { email } = req.body;

    const user = await db.query.users.findFirst({
      where: eq(users.email, email)
    });

    if (!user) {
      return res.json({ message: 'If that email exists, we sent a reset link' });
    }

    // Generate token
    const resetToken = crypto.randomBytes(32).toString('hex');
    const hashedToken = crypto.createHash('sha256').update(resetToken).digest('hex');

    // Save token
    await db.insert(passwordResetTokens).values({
      userId: user.id,
      token: hashedToken,
      expiresAt: new Date(Date.now() + 60 * 60 * 1000)
    });

    // FIXED: Token in path instead of query parameter
    const resetUrl = `${process.env.APP_URL}/#/auth/reset-password/${resetToken}`;
    //                                                            ^^^^^^^^^^^^^ Token in path

    await sendPasswordResetEmail(user.email, user.username, resetUrl);

    res.json({ message: 'If that email exists, we sent a reset link' });
  } catch (error) {
    console.error('[Auth] Forgot password error:', error);
    res.status(500).send('Failed to process request');
  }
});
```

### Frontend: Update Route to Accept Token Parameter

```typescript
// client/src/App.tsx

function PublicRoutes() {
  return (
    <div className="flex flex-col min-h-screen">
      <div className="flex-1">
        <Switch>
          <Route path="/pricing" component={Pricing} />
          <Route path="/terms" component={Terms} />
          <Route path="/auth/login" component={Login} />
          <Route path="/auth/forgot-password" component={ForgotPassword} />
          
          {/* FIXED: Accept token as path parameter */}
          <Route path="/auth/reset-password/:token" component={ResetPassword} />
          
          <Route path="/" component={Landing} />
          <Route component={NotFound} />
        </Switch>
      </div>
      <Footer />
    </div>
  );
}
```

### Update ResetPassword Component to Use Path Parameter

```typescript
// client/src/pages/reset-password.tsx

import { useState } from 'react';
import { useRoute } from 'wouter';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { useToast } from '@/hooks/use-toast';

export default function ResetPassword() {
  // FIXED: Get token from URL path parameter
  const [match, params] = useRoute('/auth/reset-password/:token');
  const token = params?.token;
  
  const [password, setPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const { toast } = useToast();

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (!token) {
      toast({
        title: 'Invalid Link',
        description: 'This password reset link is invalid',
        variant: 'destructive'
      });
      return;
    }

    if (password !== confirmPassword) {
      toast({
        title: 'Passwords do not match',
        variant: 'destructive'
      });
      return;
    }

    if (password.length < 8) {
      toast({
        title: 'Password too short',
        description: 'Password must be at least 8 characters',
        variant: 'destructive'
      });
      return;
    }

    setIsLoading(true);

    try {
      const response = await fetch('/api/auth/reset-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token, newPassword: password })
      });

      if (response.ok) {
        toast({
          title: 'Password Reset!',
          description: 'You can now log in with your new password'
        });
        
        // Redirect to login
        window.location.hash = '#/auth/login';
      } else {
        const error = await response.text();
        toast({
          title: 'Reset Failed',
          description: error,
          variant: 'destructive'
        });
      }
    } catch (error) {
      toast({
        title: 'Error',
        description: 'Failed to reset password',
        variant: 'destructive'
      });
    } finally {
      setIsLoading(false);
    }
  };

  if (!match || !token) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <div className="max-w-md p-8 bg-card rounded-lg border">
          <h1 className="text-2xl font-bold mb-4">Invalid Link</h1>
          <p className="text-muted-foreground mb-4">
            This password reset link is invalid or has expired.
          </p>
          <Button onClick={() => window.location.hash = '#/auth/forgot-password'}>
            Request New Link
          </Button>
        </div>
      </div>
    );
  }

  return (
    <div className="flex items-center justify-center min-h-screen p-4">
      <div className="max-w-md w-full p-8 bg-card rounded-lg border">
        <h1 className="text-2xl font-bold mb-2">Reset Password</h1>
        <p className="text-muted-foreground mb-6">
          Enter your new password
        </p>

        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="text-sm font-medium">New Password</label>
            <Input
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              required
              minLength={8}
            />
          </div>

          <div>
            <label className="text-sm font-medium">Confirm Password</label>
            <Input
              type="password"
              value={confirmPassword}
              onChange={(e) => setConfirmPassword(e.target.value)}
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              required
              minLength={8}
            />
          </div>

          <Button type="submit" className="w-full" disabled={isLoading}>
            {isLoading ? 'Resetting...' : 'Reset Password'}
          </Button>
        </form>

        <div className="mt-4 text-center">
          <a 
            href="#/auth/login" 
            className="text-sm text-primary hover:underline"
          >
            Back to Login
          </a>
        </div>
      </div>
    </div>
  );
}
```

---

## ‚úÖ Solution 2: Custom Hash Location Hook with Query Parameters

If you want to keep query parameters, create a custom hook:

```typescript
// client/src/lib/useHashLocationWithQuery.ts

import { useHashLocation } from 'wouter/use-hash-location';

export function useHashLocationWithQuery() {
  const [location, setLocation] = useHashLocation();
  
  // Parse query parameters from hash
  const getQueryParams = () => {
    const hash = window.location.hash;
    const queryStart = hash.indexOf('?');
    
    if (queryStart === -1) return {};
    
    const queryString = hash.substring(queryStart + 1);
    const params = new URLSearchParams(queryString);
    
    const result: Record<string, string> = {};
    params.forEach((value, key) => {
      result[key] = value;
    });
    
    return result;
  };

  return {
    location,
    setLocation,
    queryParams: getQueryParams()
  };
}
```

Then use it:

```typescript
// client/src/pages/reset-password.tsx

import { useHashLocationWithQuery } from '@/lib/useHashLocationWithQuery';

export default function ResetPassword() {
  const { queryParams } = useHashLocationWithQuery();
  const token = queryParams.token;

  // Rest of component...
}
```

---

## ‚úÖ Solution 3: Switch to Browser History Router

If you don't need hash routing, switch to regular browser routing:

```typescript
// client/src/App.tsx

// Remove this:
// import { useHashLocation } from "wouter/use-hash-location";

// And change:
<WouterRouter hook={useHashLocation}>

// To:
<WouterRouter>
```

Then configure your server to serve index.html for all routes:

```typescript
// server/index.ts

// Serve all routes with index.html (for browser history routing)
app.get('*', (req, res) => {
  res.sendFile(path.join(__dirname, '../dist/index.html'));
});
```

And update email URLs to remove hash:

```typescript
const resetUrl = `${process.env.APP_URL}/auth/reset-password?token=${resetToken}`;
```

---

## üéØ Recommended Solution

**Use Solution 1 (Token in Path)** - it's the most reliable with hash routing:

### URL Format
```
Before: https://lyricsensei.com/#/auth/reset-password?token=abc123  ‚ùå Token lost
After:  https://lyricsensei.com/#/auth/reset-password/abc123        ‚úÖ Token preserved
```

### Quick Implementation Checklist

1. Update backend to generate URL with token in path:
   ```typescript
   const resetUrl = `${process.env.APP_URL}/#/auth/reset-password/${resetToken}`;
   ```

2. Update route to accept token parameter:
   ```typescript
   <Route path="/auth/reset-password/:token" component={ResetPassword} />
   ```

3. Update ResetPassword component to use `useRoute()`:
   ```typescript
   const [match, params] = useRoute('/auth/reset-password/:token');
   const token = params?.token;
   ```

4. Test the flow:
   - Request password reset
   - Check email
   - Click link
   - Verify token appears in URL
   - Enter new password
   - Success!

**This approach works perfectly with hash routing and is the simplest fix!** üîß‚ú®